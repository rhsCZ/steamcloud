name: Sync Workflows to All Branches

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: backend  # změň podle nové hlavní větve
          fetch-depth: 0

      - name: Get list of branches
        id: branches
        run: |
          branches=$(git for-each-ref --format="%(refname:short)" refs/heads/ \
            | grep -v '^backend$' \
            | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "branches=$branches" >> "$GITHUB_OUTPUT"

      - name: Debug branches
        run: |
          echo "Branches from output:"
          echo '${{ steps.branches.outputs.branches }}' | jq .


      - name: Sync workflows to each branch
        run: |
          for branch in $(echo '${{ steps.branches.outputs.branches }}' | jq -r '.[]'); do
            echo "===> Syncing to $branch"
            git checkout "$branch"

            # Přepíše složku workflows ze zdrojové větve
            git checkout backend -- .github/workflows

            git config user.name "github-actions"
            git config user.email "github-actions@github.com"

            if git diff --quiet; then
              echo "No changes to commit for $branch"
            else
              git add .github/workflows
              git commit -m "Sync workflows from backend"
              git push origin "$branch"
            fi
          done
